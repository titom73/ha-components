blueprint:
  name: "Daily Weather via Telegram (telegram_bot) â€” FR message + alerts + presence (+ date/heure unique)"
  description: >
    Envoie un message mÃ©tÃ©o en franÃ§ais (avec banniÃ¨re dâ€™alerte mÃ©tÃ©o facultative) Ã  un ou plusieurs chats Telegram,
    et attache des snapshots dâ€™une ou plusieurs camÃ©ras.
    Peut fonctionner :
      - chaque jour Ã  une heure (input_datetime time-only)
      - une seule fois Ã  une date+heure prÃ©cise (input_datetime date+time).
    Ne sâ€™exÃ©cute que si le boolÃ©en de prÃ©sence choisi est sur ON (mode absence par dÃ©faut).
    Supporte la sÃ©lection dâ€™un bot Telegram spÃ©cifique via config_entry_id.

  domain: automation

  input:
    time_helper:
      name: Daily time helper (input_datetime, time-only)
      description: "Si dÃ©fini, dÃ©clenche chaque jour Ã  cette heure."
      selector:
        entity:
          domain: input_datetime

    run_datetime:
      name: (Optionnel) Date & heure unique (input_datetime)
      description: "Si dÃ©fini (date+time), dÃ©clenche une fois Ã  cette date & heure."
      default:
      selector:
        entity:
          domain: input_datetime

    presence_boolean:
      name: BoolÃ©en PrÃ©sence/Absence
      description: >
        BoolÃ©en qui contrÃ´le lâ€™exÃ©cution. Lâ€™automatisation ne sâ€™exÃ©cute que si ce boolÃ©en est ON.
        Exemple typique : input_boolean.absent (ON = absent).
      selector:
        entity:
          domain: input_boolean

    indoor_temp:
      name: Capteur tempÃ©rature piÃ¨ce principale
      selector:
        entity:
          domain: sensor

    outdoor_temp:
      name: Capteur tempÃ©rature extÃ©rieure
      selector:
        entity:
          domain: sensor

    cameras:
      name: CamÃ©ras pour snapshots
      description: "Une ou plusieurs camÃ©ras dont on prend un snapshot Ã  envoyer."
      selector:
        entity:
          domain: camera
          multiple: true

    chat_ids:
      name: Chat IDs Telegram
      description: "Un ou plusieurs IDs numÃ©riques de chat pour votre bot Telegram."
      selector:
        text:
          multiple: true
          type: text

    weather_alert_sensor:
      name: (Optionnel) Capteur alerte mÃ©tÃ©o
      description: "Capteur exposant les niveaux de vigilance (ex : intÃ©gration MÃ©tÃ©o-France)."
      default:
      selector:
        entity:
          domain: sensor

    telegram_config_entry_id:
      name: (Optionnel) Telegram bot config_entry_id
      description: >
        Si vous avez plusieurs bots Telegram, renseignez le config_entry_id du bot Ã  utiliser.
        Laissez vide pour utiliser le bot par dÃ©faut.
      default: ""
      selector:
        text:
          type: text

mode: single
trace:
  stored_traces: 20

trigger:
  # Daily trigger at the selected time (input_datetime time-only).
  - id: daily_time
    trigger: time
    at: !input time_helper

  # One-shot trigger at run_datetime (date+time).
  # Fires when local YYYY-MM-DD HH:MM matches the helper value.
  - id: run_once_datetime
    trigger: template
    value_template: >-
      {% set e = run_dt %}
      {% if not e %}
        false
      {% else %}
        {{ now().strftime('%Y-%m-%d %H:%M') == (as_datetime(states(e)) | as_local).strftime('%Y-%m-%d %H:%M') }}
      {% endif %}

condition:
  # Only run if presence_boolean is ON
  - condition: state
    entity_id: !input presence_boolean
    state: "on"

variables:
  ts: "{{ now().strftime('%Y%m%d-%H%M%S') }}"         # Timestamp used in filenames
  indoor_sensor: !input indoor_temp
  outdoor_sensor: !input outdoor_temp
  cams: !input cameras
  tg_chats: !input chat_ids
  alert_ent: !input weather_alert_sensor
  tg_cfg: !input telegram_config_entry_id
  run_dt: !input run_datetime

  # Macro name and call name MATCH (Option A)
  cam_slug: >-
    {% macro cam_slug(e) -%}
      {{ e | replace('.', '_') | replace(':', '_') }}
    {%- endmacro %}

  # --- Alert banner in French (generalized from your original logic) ---
  alert_text: >-
    {% if alert_ent %}
      {% set ok = states(alert_ent) not in ['unknown','unavailable', none] %}
      {% set attrs = states(alert_ent).attributes if ok else dict() %}
      {% set ignore = ['friendly_name','icon'] %}
      {% set order = ['Rouge','Orange','Jaune'] %}
      {% set emoji = {'Rouge':'ðŸŸ¥','Orange':'ðŸŸ§','Jaune':'ðŸŸ¨','Vert':'ðŸŸ©'} %}
      {% set ns = namespace(parts=[]) %}
      {% for level in order %}
        {% for k in attrs %}
          {% if k not in ignore and attrs[k]==level %}
            {% set ns.parts = ns.parts + [ emoji[level] ~ ' ' ~ k ~ ' (' ~ level ~ ')' ] %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {% if ok and ns.parts|length>0 -%}
        __Attention, alerte mÃ©tÃ©o en cours__ : {{ ns.parts | join(', ') }}
      {%- elif ok and states(alert_ent)!='Vert' -%}
        __Attention, alerte mÃ©tÃ©o en cours__ : {{ emoji.get(states(alert_ent),'â—') }} {{ states(alert_ent) }}
      {%- endif %}
    {% endif %}

  # --- weather_msg EXACTLY as you requested (keeps Jinja trim markers) ---
  weather_msg: |-
    {% set in_ok = states(indoor_sensor) not in ['unknown','unavailable', none] %}
    {% set out_ok = states(outdoor_sensor) not in ['unknown','unavailable', none] %}
    Bonjour,

    Aujourd'hui :

    {%- if out_ok %}
    â€¢ TempÃ©rature extÃ©rieure : {{ states(outdoor_sensor) }} Â°C
    {%- else %}
    â€¢ TempÃ©rature extÃ©rieure : (indisponible)
    {%- endif %}
    â€¢ Maximum attendu de __{{ states('sensor.meteo_maison_accuweather_temperature_ressentie_maximum_aujourd_hui') }}__
    {%- if in_ok %}
    â€¢ TempÃ©rature piÃ¨ce principale : {{ states(indoor_sensor) }} Â°C
    {%- else %}
    â€¢ TempÃ©rature piÃ¨ce principale : (indisponible)
    {%- endif %}
    
    {{ alert_text }}
    
    EnvoyÃ© le {{ now().strftime('%d/%m/%Y %H:%M') }}.

action:
  # --- Send the text message ---
  - choose:
      - conditions: "{{ tg_cfg | trim != '' }}"
        sequence:
          - alias: "Send text with selected Telegram bot"
            action: telegram_bot.send_message
            data:
              target: !input chat_ids
              title: "MÃ©tÃ©o de la maison"
              message: "{{ weather_msg }}"
              config_entry_id: "{{ tg_cfg }}"
    default:
      - alias: "Send text with default Telegram bot"
        action: telegram_bot.send_message
        data:
          target: !input chat_ids
          title: "MÃ©tÃ©o de la maison"
          message: "{{ weather_msg }}"

  # --- Snapshot each camera and send to all chats ---
  - repeat:
      for_each: !input cameras
      sequence:
        - variables:
            cam_entity: "{{ repeat.item }}"
            file_path: >-
              {{ '/config/www/snapshots/' ~ cam_slug(cam_entity) ~ '_' ~ ts ~ '.jpg' }}

        - alias: "Create snapshot (use data.entity_id instead of target)"
          continue_on_error: false
          action: camera.snapshot
          data:
            entity_id: "{{ cam_entity }}"
            filename: "{{ file_path }}"

        - delay: "00:00:01"  # small delay to ensure the file is written

        - choose:
            - conditions: "{{ tg_cfg | trim != '' }}"
              sequence:
                - alias: "Send snapshot with selected Telegram bot"
                  action: telegram_bot.send_photo
                  data:
                    target: !input chat_ids
                    file: "{{ file_path }}"
                    caption: >-
                      {{ state_attr(cam_entity, 'friendly_name') or cam_entity }} â€” {{ now().strftime('%d/%m/%Y %H:%M') }}
                    config_entry_id: "{{ tg_cfg }}"
          default:
            - alias: "Send snapshot with default Telegram bot"
              action: telegram_bot.send_photo
              data:
                target: !input chat_ids
                file: "{{ file_path }}"
                caption: >-
                  {{ state_attr(cam_entity, 'friendly_name') or cam_entity }} â€” {{ now().strftime('%d/%m/%Y %H:%M') }}
