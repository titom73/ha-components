blueprint:
  name: Daily Weather Report - Version AmÃ©liorÃ©e
  description: |
    Envoie un rapport mÃ©tÃ©o quotidien enrichi via Telegram avec :
    - TempÃ©ratures actuelles et prÃ©visions
    - Conditions mÃ©tÃ©o depuis weather entity
    - Comparaison consommation Ã©lectrique J-1 vs J-2
    - Ã‰tat des thermostats
    - Alertes mÃ©tÃ©o
    - Snapshots camÃ©ras
  domain: automation
  input:
    time_helper:
      name: Heure d'envoi
      description: input_datetime dÃ©finissant l'heure d'envoi quotidien
      selector:
        entity:
          domain: input_datetime
          multiple: false
    presence_boolean:
      name: Condition de prÃ©sence
      description: Ne s'exÃ©cute que si ce boolÃ©en est ON (ex. input_boolean.absent)
      selector:
        entity:
          domain: input_boolean
          multiple: false
    indoor_temp_sensor:
      name: Capteur tempÃ©rature intÃ©rieure
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false
    weather_entity:
      name: EntitÃ© mÃ©tÃ©o
      description: Entity weather.* pour les prÃ©visions (ex. weather.massy)
      selector:
        entity:
          domain: weather
          multiple: false
    energy_sensor:
      name: Capteur consommation totale
      description: Sensor d'Ã©nergie total pour calculer J-1 vs J-2
      selector:
        entity:
          domain: sensor
          device_class: energy
          multiple: false
    climate_entities:
      name: Thermostats Ã  surveiller
      description: Liste des thermostats climate.* pour le rÃ©sumÃ© chauffage
      default: []
      selector:
        entity:
          domain: climate
          multiple: true
    weather_alert_sensor:
      name: (Optionnel) Capteur alerte mÃ©tÃ©o
      description: Capteur d'alerte MÃ©tÃ©o-France (ex. sensor.91_weather_alert)
      default: ""
      selector:
        entity:
          domain: sensor
          multiple: false
    cameras:
      name: CamÃ©ras pour snapshots
      description: Une ou plusieurs camÃ©ras dont on prend un snapshot
      default: []
      selector:
        entity:
          domain: camera
          multiple: true
    telegram_chat_ids:
      name: Chat IDs Telegram
      description: IDs numÃ©riques des chats Telegram (un par ligne)
      selector:
        text:
          multiple: true
          multiline: false
    telegram_config_entry_id:
      name: (Optionnel) Telegram bot config_entry_id
      description: ID du bot Telegram Ã  utiliser (laisser vide pour le dÃ©faut)
      default: ""
      selector:
        text:
          multiple: false

mode: single
trace:
  stored_traces: 20

trigger:
- trigger: time
  at: !input time_helper

condition:
- condition: state
  entity_id: !input presence_boolean
  state: 'on'

variables:
  ts: '{{ now().strftime("%Y%m%d-%H%M%S") }}'
  indoor_sensor: !input indoor_temp_sensor
  weather_entity: !input weather_entity
  energy_sensor: !input energy_sensor
  climate_list: !input climate_entities
  alert_sensor: !input weather_alert_sensor
  cams: !input cameras
  tg_chats: !input telegram_chat_ids
  tg_cfg: !input telegram_config_entry_id

  # TempÃ©ratures
  indoor_temp: "{{ states(indoor_sensor) | float(0) | round(1) }}"
  outdoor_temp: "{{ state_attr(weather_entity, 'temperature') | float(0) | round(1) }}"
  temp_min: "{{ state_attr(weather_entity, 'forecast')[0].templow if state_attr(weather_entity, 'forecast') else 'N/A' }}"
  temp_max: "{{ state_attr(weather_entity, 'forecast')[0].temperature if state_attr(weather_entity, 'forecast') else 'N/A' }}"

  # Conditions mÃ©tÃ©o
  weather_condition: "{{ states(weather_entity) }}"
  humidity: "{{ state_attr(weather_entity, 'humidity') | int(0) }}"
  wind_speed: "{{ state_attr(weather_entity, 'wind_speed') | float(0) | round(1) }}"

  weather_emoji: >
    {% set condition = states(weather_entity) %}
    {% set emojis = {
      'clear-night': 'ðŸŒ™',
      'cloudy': 'â˜ï¸',
      'fog': 'ðŸŒ«ï¸',
      'hail': 'ðŸŒ¨ï¸',
      'lightning': 'â›ˆï¸',
      'lightning-rainy': 'â›ˆï¸',
      'partlycloudy': 'â›…',
      'pouring': 'ðŸŒ§ï¸',
      'rainy': 'ðŸŒ¦ï¸',
      'snowy': 'ðŸŒ¨ï¸',
      'snowy-rainy': 'ðŸŒ¨ï¸',
      'sunny': 'â˜€ï¸',
      'windy': 'ðŸ’¨',
      'windy-variant': 'ðŸ’¨',
      'exceptional': 'âš ï¸'
    } %}
    {{ emojis.get(condition, 'ðŸŒ¤ï¸') }}

  weather_label: >
    {% set condition = states(weather_entity) %}
    {% set labels = {
      'clear-night': 'Nuit claire',
      'cloudy': 'Nuageux',
      'fog': 'Brouillard',
      'hail': 'GrÃªle',
      'lightning': 'Orageux',
      'lightning-rainy': 'Orage pluvieux',
      'partlycloudy': 'Partiellement nuageux',
      'pouring': 'Pluie battante',
      'rainy': 'Pluvieux',
      'snowy': 'Neigeux',
      'snowy-rainy': 'Neige et pluie',
      'sunny': 'EnsoleillÃ©',
      'windy': 'Venteux',
      'windy-variant': 'Venteux',
      'exceptional': 'Exceptionnel'
    } %}
    {{ labels.get(condition, condition) }}

  # Consommation Ã©lectrique J-1 vs J-2
  energy_yesterday: >
    {% set yesterday = now().replace(hour=0, minute=0, second=0, microsecond=0) - timedelta(days=1) %}
    {% set yesterday_start = yesterday.timestamp() %}
    {% set yesterday_end = (yesterday + timedelta(days=1)).timestamp() %}
    {{ (states(energy_sensor) | float(0) - state_attr(energy_sensor, 'last_reset') | default(0)) | round(1) }}

  energy_day_before: >
    {% set day_before = now().replace(hour=0, minute=0, second=0, microsecond=0) - timedelta(days=2) %}
    {{ 0 }}

  energy_diff: >
    {{ (energy_yesterday | float(0) - energy_day_before | float(0)) | round(1) }}

  energy_diff_percent: >
    {% set diff = energy_yesterday | float(0) - energy_day_before | float(0) %}
    {% if energy_day_before | float(0) > 0 %}
      {{ ((diff / (energy_day_before | float(0))) * 100) | round(0) }}
    {% else %}
      0
    {% endif %}

  energy_trend: >
    {% set diff = energy_yesterday | float(0) - energy_day_before | float(0) %}
    {% if diff > 0 %}ðŸ“ˆ{% elif diff < 0 %}ðŸ“‰{% else %}âž¡ï¸{% endif %}

  # RÃ©sumÃ© thermostats
  climate_summary: >
    {% set ns = namespace(lines=[]) %}
    {% for climate in climate_list %}
      {% set preset = state_attr(climate, 'preset_mode') %}
      {% set current = state_attr(climate, 'current_temperature') | float(0) | round(1) %}
      {% set target = state_attr(climate, 'temperature') | float(0) | round(1) %}
      {% set name = state_attr(climate, 'friendly_name') %}
      {% set preset_emoji = {
        'comfort': 'ðŸ˜Š',
        'eco': 'ðŸŒ¿',
        'boost': 'âš¡',
        'away': 'ðŸš¶',
        'frost': 'â„ï¸',
        'off': 'âŒ'
      } %}
      {% set preset_label = {
        'comfort': 'Confort',
        'eco': 'Ã‰co',
        'boost': 'Boost',
        'away': 'Absence',
        'frost': 'Hors-gel',
        'off': 'ArrÃªt'
      } %}
      {% if current != target %}
        {% set line = 'â€¢ ' ~ name ~ ' : ' ~ preset_label.get(preset, preset) ~ ' ' ~ preset_emoji.get(preset, '') ~ ' (' ~ current ~ 'Â°C â†’ ' ~ target ~ 'Â°C)' %}
      {% else %}
        {% set line = 'â€¢ ' ~ name ~ ' : ' ~ preset_label.get(preset, preset) ~ ' ' ~ preset_emoji.get(preset, '') ~ ' (' ~ current ~ 'Â°C)' %}
      {% endif %}
      {% set ns.lines = ns.lines + [line] %}
    {% endfor %}
    {{ ns.lines | join('\n') if ns.lines else 'â€¢ Aucun thermostat configurÃ©' }}

  # Alertes mÃ©tÃ©o
  alert_text: >
    {% if alert_sensor and states(alert_sensor) not in ['unknown', 'unavailable', 'Vert', none] %}
      {% set level = states(alert_sensor) %}
      {% set emoji = {'Rouge':'ðŸ”´','Orange':'ðŸŸ ','Jaune':'ðŸŸ¡','Vert':'ðŸŸ¢'} %}
      {{ emoji.get(level, 'âš ï¸') ~ ' ' ~ level }}
    {% else %}
      Aucune
    {% endif %}

  # Message complet
  weather_msg: |
    ðŸ  *MÃ©tÃ©o de la maison*
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    ðŸŒ¡ï¸ *TempÃ©ratures*
    â€¢ ExtÃ©rieur : {{ outdoor_temp }}Â°C
    â€¢ Salon : {{ indoor_temp }}Â°C
    â€¢ Min/Max aujourd'hui : {{ temp_min }}Â°C / {{ temp_max }}Â°C

    {{ weather_emoji }} *Conditions*
    â€¢ Ã‰tat : {{ weather_label }}
    â€¢ HumiditÃ© : {{ humidity }}%
    {% if wind_speed > 0 %}â€¢ Vent : {{ wind_speed }} km/h{% endif %}

    âš¡ *Consommation Ã©lectrique*
    â€¢ Hier (J-1) : {{ energy_yesterday }} kWh
    â€¢ Avant-hier (J-2) : {{ energy_day_before }} kWh
    â€¢ DiffÃ©rence : {{ energy_diff }} kWh {{ energy_trend }} ({{ energy_diff_percent }}%)

    ðŸ”¥ *Chauffage*
    {{ climate_summary }}

    ðŸš¨ *Alerte mÃ©tÃ©o* : {{ alert_text }}

    ðŸ“… {{ now().strftime('%d/%m/%Y Ã  %H:%M') }}

action:
# Envoi du message texte
- choose:
  - conditions: '{{ tg_cfg | trim != "" }}'
    sequence:
    - action: telegram_bot.send_message
      data:
        target: !input telegram_chat_ids
        message: '{{ weather_msg }}'
        parse_mode: markdown
        config_entry_id: '{{ tg_cfg }}'
  default:
  - action: telegram_bot.send_message
    data:
      target: !input telegram_chat_ids
      message: '{{ weather_msg }}'
      parse_mode: markdown

# Envoi des snapshots camÃ©ras
- repeat:
    for_each: !input cameras
    sequence:
    - variables:
        cam_entity: '{{ repeat.item }}'
        file_path: "{{ '/config/www/snapshots/' ~ cam_entity | replace('.', '_') | replace(':', '_') ~ '_' ~ ts ~ '.jpg' }}"
    - action: camera.snapshot
      continue_on_error: true
      data:
        entity_id: '{{ cam_entity }}'
        filename: '{{ file_path }}'
    - delay: 00:00:01
    - choose:
      - conditions: '{{ tg_cfg | trim != "" }}'
        sequence:
        - action: telegram_bot.send_photo
          data:
            target: !input telegram_chat_ids
            file: '{{ file_path }}'
            caption: '{{ state_attr(cam_entity, "friendly_name") or cam_entity }} â€” {{ now().strftime("%d/%m/%Y %H:%M") }}'
            config_entry_id: '{{ tg_cfg }}'
      default:
      - action: telegram_bot.send_photo
        data:
          target: !input telegram_chat_ids
          file: '{{ file_path }}'
          caption: '{{ state_attr(cam_entity, "friendly_name") or cam_entity }} â€” {{ now().strftime("%d/%m/%Y %H:%M") }}'
