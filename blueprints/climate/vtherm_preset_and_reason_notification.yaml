blueprint:
  name: Notification changement preset chauffage + raison VTherm
  description: >
    Envoie une notification mobile lorsque le preset d'un thermostat
    Versatile Thermostat change et/ou que sa raison d'arrÃªt (hvac_off_reason) change.
    Message friendly en franÃ§ais avec emojis.
  domain: automation

  input:

    vtherm_climate:
      name: Thermostat VTherm Ã  surveiller
      description: EntitÃ© climate.* du thermostat Versatile Thermostat
      selector:
        entity:
          domain: climate

    notify_service:
      name: Service de notification mobile
      description: >
        Nom complet du service notify, par exemple:
        notify.mobile_app_iphone_de_thomas
      default: notify.mobile_app_iphone_de_thomas
      selector:
        text: {}

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input vtherm_climate

variables:

  vtherm: !input vtherm_climate
  notify_service: !input notify_service

  # Etats sources
  old_state: "{{ trigger.from_state }}"
  new_state: "{{ trigger.to_state }}"

  # Presets bruts
  old_preset: "{{ old_state.attributes.preset_mode if old_state else 'unknown' }}"
  new_preset: "{{ new_state.attributes.preset_mode if new_state else 'unknown' }}"

  # hvac_off_reason brut
  old_reason: "{{ old_state.attributes.hvac_off_reason if old_state and 'hvac_off_reason' in old_state.attributes else 'none' }}"
  new_reason: "{{ new_state.attributes.hvac_off_reason if new_state and 'hvac_off_reason' in new_state.attributes else 'none' }}"

  # Dictionnaire de labels pour les presets
  preset_labels: >
    {{
      {
        'comfort': 'Confort ğŸ˜Š',
        'comfort_away': 'Confort (absence) ğŸ â¡ï¸ğŸš¶',
        'eco': 'Eco ğŸŒ¿',
        'eco_away': 'Eco (absence) ğŸŒ¿ğŸš¶',
        'away': 'Absence longue ğŸš¶â€â™‚ï¸ğŸ’¼',
        'boost': 'Boost âš¡ğŸ”¥',
        'off': 'ArrÃªt âŒ',
        'none': 'Aucun',
        'unknown': 'Inconnu â“'
      }
    }}

  old_preset_label: "{{ preset_labels.get(old_preset, old_preset) }}"
  new_preset_label: "{{ preset_labels.get(new_preset, new_preset) }}"

  # Dictionnaire de labels pour hvac_off_reason (adapter selon ton usage VTherm)
  reason_labels: >
    {{
      {
        'none': 'Aucune (chauffage autorisÃ© âœ…)',
        'window_open': 'FenÃªtre ouverte ğŸªŸ (chauffage coupÃ©)',
        'frost_protection': 'Protection hors gel â„ï¸',
        'max_temp_exceeded': 'TempÃ©rature max atteinte ğŸŒ¡ï¸',
        'safety': 'SÃ©curitÃ© / protection âš ï¸',
        'external_block': 'BloquÃ© par une autre logique externe ğŸ”',
        'power_off': 'Alimentation coupÃ©e ğŸ”Œ',
        'unknown': 'Inconnue â“'
      }
    }}

  mapped_old_reason: >
    {% set r = old_reason if old_reason is not none else 'none' %}
    {{ reason_labels.get(r, r) }}

  mapped_new_reason: >
    {% set r = new_reason if new_reason is not none else 'none' %}
    {{ reason_labels.get(r, r) }}

  # Flags de changement
  preset_changed: "{{ old_preset != new_preset }}"
  reason_changed: "{{ old_reason != new_reason }}"

  # Equipement sous-jacent (radiateur / valve / autre)
  heater: >-
    {{
      state_attr(vtherm, 'heater_entity_id')
      or state_attr(vtherm, 'climate_entity_id')
      or state_attr(vtherm, 'valve_entity_id')
      or 'Ã‰quipement inconnu'
    }}

action:

  # On ne notifie que si AU MOINS l'un des deux a changÃ©
  - condition: template
    value_template: "{{ preset_changed or reason_changed }}"

  - service: "{{ notify_service }}"
    data:
      title: >
        {% if preset_changed and reason_changed %}
          ğŸ”¥ Chauffage : mode et Ã©tat modifiÃ©s
        {% elif preset_changed %}
          ğŸ”¥ Chauffage : changement de mode
        {% else %}
          ğŸ”¥ Chauffage : changement d'Ã©tat
        {% endif %}
      message: >
        {% set name = new_state.name if new_state else vtherm %}

        Thermostat *{{ name }}* :

        {% if preset_changed %}
        â€¢ Ancien mode : **{{ old_preset_label }}**
        â€¢ Nouveau mode : **{{ new_preset_label }}**
        {% else %}
        â€¢ Mode courant : **{{ new_preset_label }}**
        {% endif %}

        {% if reason_changed %}
        â€¢ Ancienne raison d'arrÃªt : {{ mapped_old_reason }}
        â€¢ Nouvelle raison d'arrÃªt : {{ mapped_new_reason }}
        {% else %}
        â€¢ Raison d'arrÃªt actuelle : {{ mapped_new_reason }}
        {% endif %}

        ğŸ”§ Ã‰quipement pilotÃ© : {{ heater }}

        ğŸ’¡ Information automatique fournie par Versatile Thermostat âœ”ï¸
